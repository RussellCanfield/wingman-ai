name: Desktop Build

on:
    pull_request:
        paths:
            - "apps/desktop/**"
            - ".github/workflows/desktop-build.yml"
    push:
        branches:
            - main
        paths:
            - "apps/desktop/**"
            - ".github/workflows/desktop-build.yml"
    workflow_dispatch:

jobs:
    build:
        name: Build (${{ matrix.os }})
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                os:
                    - macos-latest
                    - windows-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Setup Rust
              uses: dtolnay/rust-toolchain@stable

            - name: Add Windows x64 Target
              if: runner.os == 'Windows'
              run: rustup target add x86_64-pc-windows-msvc

            - name: Install WiX Toolset
              if: runner.os == 'Windows'
              run: choco install wixtoolset -y

            - name: Install Desktop Dependencies
              working-directory: ./apps/desktop
              run: bun install

            - name: Run Desktop Tests
              working-directory: ./apps/desktop
              run: bun run test

            - name: Run Desktop Rust Unit Tests
              run: cargo test --manifest-path apps/desktop/src-tauri/Cargo.toml

            - name: Build Desktop Web Shell
              working-directory: ./apps/desktop
              run: bun run build:web

            - name: Build Tauri (macOS)
              if: runner.os == 'macOS'
              working-directory: ./apps/desktop
              run: bun run tauri:build -- --bundles app,dmg

            - name: Build Tauri (Windows x64)
              if: runner.os == 'Windows'
              working-directory: ./apps/desktop
              run: bun run tauri:build -- --target x86_64-pc-windows-msvc --bundles msi,nsis

            - name: Upload macOS Bundle Artifacts
              if: runner.os == 'macOS'
              uses: actions/upload-artifact@v4
              with:
                  name: desktop-macos-bundle
                  path: apps/desktop/src-tauri/target/release/bundle

            - name: Upload Windows Bundle Artifacts
              if: runner.os == 'Windows'
              uses: actions/upload-artifact@v4
              with:
                  name: desktop-windows-x64-bundle
                  path: apps/desktop/src-tauri/target/x86_64-pc-windows-msvc/release/bundle
